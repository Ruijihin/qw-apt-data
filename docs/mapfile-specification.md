# QW787グラウンドマップファイル仕様

これまでの調査で判明したグラウンドマップファイルの仕様を記載します。  
ただし、動作の仕様がXMLファイルを扱っているとは思えない異質な部分も多く、バグのようなものも散見されるため、全ての仕様を正確に記述できているものとは限りませんのでご了承ください。

## ファイル名

ファイル名は、`対称空港のICAOコード.xml`とする。  
例えば、羽田空港であれば`RJTT.xml`。  

## ファイル宣言とルート構造

XMLの宣言のあとに`<FSData>`タグを記述する(属性も必要)。  
`<FSData>`タグが空港データのルートであり、この中に全ての内容を記述する。

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<FSData
  version="9.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="bglcomp.xsd">

<!-- ここに全ての内容を記載する。 -->

</FSData>
```

## 構造物データ

構造物はND上にシアンで表示される。
ルート直下に以下のように記述する。

```xml
<SceneryObject
  lat="35.00"
  lon="135.00"
>
    <Footprint
      <Poly
        <Point 
          X="-30"
          Y="30"/>
        <Point
          X="-30"
          Y="-30"/>
        <Point
          X="30"
          Y="-30"/>
        <Point
          X="30" 
          Y="30"/>
        />
    />
</SceneryObject>
```

* `<SceneryObject>`: 構造物の基準座標を定義する。
  * `lat`: 緯度。精度に制限はない。南緯はマイナスで記述する。
  * `lon`: 経度。緯度と同様。西経はマイナスで記述する。
* `<Footprint`: `<SceneryObject>`内に一つ定義する。`<Footprint>`内には複数の`<Poly>`を定義できる。
  * `<Poly`: 中の`<Point>`を上から順番に一筆書きで頂点として図形を生成する。
    * `<Point>`: 構造物の頂点を定義する。
      * `X`: `<SceneryObject>`の座標からの東西方向のオフセット。マイナスは真西、プラスが真東。単位はメートル。
      * `Y`: `<SceneryObject>`の座標からの南北方向のオフセット。マイナスは真南、プラスが真北。単位はメートル。


#### ポイント
* `<Footprint`と`<Poly`の開始タグは、`>`で閉じてはいけない。必ず`<Poly`や`<Point>`を列挙した後に`/>`で閉じること。

#### 今後の要素にも共通のポイント

* `latlon`や`XY`は必ず2行に分けて記述しなければならない。
* 詳細は解析しきれていないが、属性値の等号`(e.g. lat=34.3)`の両端にスペースを置く`(e.g. lat = 34.3)`と不正になる場合がある。
* 単体タグ`(<XXX YYY="ZZZ"/>)`の末尾の`/>`の前にスペースを置くと不正になる場合がある。  
  つまり`<XXX YYY="ZZZ" />`はNG。

> これらはXMLの仕様として不自然であるが、現状はこれを守らないと表示不正や強制終了が発生する。

## 地上データ

スポット名、誘導路、滑走路、エプロン領域の定義は、全てルート直下の`<Airport>`タグの中に記述する。

> 要素の順番は以下の通りとすることを強く推奨する。詳細は解析しきれていないが、順番を変えると表示が不正になる場合がある。

```xml
<Airport>
  <TaxiwayParking/>
  <TaxiwayPoint/>
  <TaxiwayPath/>
  <Runway/>
  <Aprons>
    <Apron></Apron>
  </Aprons>
  ......
</Airport>
```

### スポット名

スポット名はND上にシアンの文字で表示される。  
`<Airport>`直下に必要な分だけ`<TaxiwayParking>`タグを記述する。

```xml
<TaxiwayParking
  lat="34.787485152483"
  lon="135.44394493103"
  name="GATE"
  number="V11"/>
```

* `lat`: 緯度。精度に制限はない。南緯はマイナスで記述する。
* `lon`: 経度。緯度と同様。西経はマイナスで記述する。
* `name`: 固定で`GATE`を記述する。省略は不可。
* `number`: ND上に表示する文字列。半角英数記号が利用可能で3文字まで。全角は不可。

#### ポイント
* ND上に表示される文字列は、`latlon`よりもやや右下にオフセットして表示される仕様である。  
* 4文字目以降は無視される。

### 誘導路

誘導路はND上に薄いグレーで表示される。  
`<Airport>`タグ直下に`<TaxiwayPoint>`,`<TaxiwayPath>`,`<TaxiName>`を記述して定義する。

```xml
<TaxiwayPoint
  index="20"
  lat="34.7871720045805"
  lon="135.441342741251"/>
<TaxiwayPoint
  index="21"
  lat="34.7871720045805"
  lon="135.441342741251"/>

<TaxiwayPath
  type="TAXI"
  start="20"
  end="21"
  width="36.58M"
  name="1"
/>

<TaxiName
  index="1"
  name="A1"/>
```

* `<TaxiwayPoint>`: 誘導路を構成する座標を定義する。
  * `index`: `<TaxiwayPath>`から参照される通し番号。0連番の数字。
  * `lat`: 中心緯度。精度に制限はない。南緯はマイナスで記述する。
  * `lon`: 中心経度。緯度と同様。西経はマイナスで記述する。
* `<TaxiwayPath>`: `<TaxiwayPoint>`を2点選んで誘導路のパス(直線)を定義する。
  * `type`: 固定で`TAXI`とする。
  * `start`: パスの開始点。`<TaxiwayPoint>`の`index`を指定する。
  * `end`: パスの終了点。`<TaxiwayPoint>`の`index`を指定する。
  * `width`: パスの幅。
  * `name`: パスの通し番号。`<TaxiName>`から参照される。数字のみ可。
* `<TaxiName>`: 指定した`<TaxiwayPath>`の始点に表示する文字列を定義する。
  * `index`: `<TaxiwayPath>`の`name`を指定する。
  * `name`: ND上に表示する文字列。半角文字で2文字まで。

#### ポイント
* `<TaxiwayPoint>`の`index`は必ず0から、抜けなく連番をふること。守らないと表示不正となる。
* `<TaxiwayPath>`の`start`と`end`を同じにすると誘導路が描画されないが、`<TaxiName>`は表示される。
* `<TaxiName>`はスポット名と同様半角のみ。ただし先頭2文字までしか表示されない。
* `<TaxiName>`は定義しなくても良い。パスの始点に描画されるため重なりやすい。見やすさをとるならスポット名を打ったほうが良い。


### 滑走路

滑走路はND上に白色で表示され、誘導路とは区別される。  
`<Airport>`タグ直下に滑走路の本数分以下のタグを記述する。

```xml
<Runway
  number="14"
  designator="RIGHT"
  lat="34.7817626595497"
  lon="135.440291762352"
  heading="135.089996337891"
  length="3000.76M"
  width="60.05M"/>
```

* `number`: 滑走路番号
* `designator`: `LEFT`, `RIGHT`, `CENTER` もしくはブランクとする。
* `lat`: 中心緯度。精度に制限はない。南緯はマイナスで記述する。
* `lon`: 中心経度。緯度と同様。西経はマイナスで記述する。
* `heading`: `number`で指定した方向に向くときの真方位。
* `length`: 滑走路長。
* `width`: 滑走路幅。

#### ポイント
* `designator`属性は省略してはいけない。L/C/Rが不要の場合はブランク("")としておく。
* `latlon`は必ず2行に分けて記述しなければならない。
* `latlon`は中心座標。中心座標から両端に向かって滑走路長の半分づつが描画されるロジックである。


### エプロン領域

エプロンはND上に濃いグレーで表示される。  
誘導路や滑走路よりも下に描画されるため、空港の下地として利用できる。  
`<Airport>`タグ直下に`<Aprons>`タグを記述し、その中に`<Apron>`を必要な数だけ記述する。

```xml
<Aprons>
  <Apron surface="ASPHALT">
    <Vertex
        lat="34.7958854958415"
        lon="135.430702418089"/>
    <Vertex
        lat="34.7906689345837"
        lon="135.437054783106"/>
  </Apron>
<Aprons>
```

* `<Apron>`: 中の`<Vertex>`を上から順番に一筆書きで頂点として図形を生成する。
  * `<Vertex>`: エプロンの頂点を定義する。一つの`<Apron>`内には最大89個定義できる。
    * `lat`: 緯度。精度に制限はない。南緯はマイナスで記述する。
    * `lon`: 経度。緯度と同様。西経はマイナスで記述する。

#### ポイント
* 一つのエプロンに対して`<Vertex>`は89個までしか定義できない。複雑なエプロンは細かく区切ること。
* 表示精度はあまり高くない。エプロンの結合面をぴったりにすると切れ目が見えるので、重なる部分を多めに取ったほうが良い。
* `<Apron>`の`surface`属性は省略してはいけない。ただし内容は意味を持たず、空でも構わない。


## その他Tips
* ファイルのリロードのタイミングは、`CDU`の`RTEページ`で`ORIGIN`や`DEST`を入力したとき。  
  ただし、だいぶ気まぐれなので、ごちゃごちゃ弄ってうまくいかなくなった場合は以下の優先度で解決を試みる。

  1. `ORIGIN`のLSKを二回押して同じコードを再設定する(通常の手順)。
  2. `ORIGIN`を一度全く別の空港にしてNDをクリアにしてから再度入れ直す。
  3. 機体を読み込み直す。
  4. シミュレーターを再起動する。